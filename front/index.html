<html>

<head>
<link href='http://fonts.googleapis.com/css?family=Josefin+Sans:100' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="style.css">

</head>
<body>

<div id="menu">
  <label>stsh</label>
</div>


<div id="stash">

  <div id="add">
    <label id="add-label" class="">Drag file here ---|</label>
  </div>

  <div id="preview" class="hidden">
    <img id="preview-img" class="">
  </div>

  <div id="upload" class="hidden">
    <div id="progress" class=""> </div>
    <label id="progress-label" class="">Upload bigger font</label>
  </div>

  <input id="file-input" class="hidden" type="file" accept="*/*" onchange="addFiles(this.files)">
</div> <!-- /stash -->


<script type="text/javascript">

var stash    = document.getElementById("stash");
var add      = document.getElementById("add");
var progress = document.getElementById("progress");
// var fileInfo = document.getElementById("file-info");
var upload   = document.getElementById("upload");

var _files   = [];

stash.className = "stash1";
add.className = "";


// Loads the preview of the first file given
function addFiles (files)
{
  // Hide "Add text"
  e("add").className = "hidden";
  _file = files[0];
  loadPreview(_file);
}

function loadPreview (file)
{
  console.log(file);
  e("preview").className = "";
  e("upload").className = "";

  if (file.type.indexOf("image") >= 0)
  {
    document.getElementById("preview-img").style.background = "url(" + URL.createObjectURL(file) + ") no-repeat center";
    document.getElementById("preview-img").className = "";
    console.log(URL.createObjectURL(file));
  }

  var reader = new FileReader();
  reader.onload = function(evt) {
    // console.log(evt.target.result);
  };
  reader.readAsBinaryString(file);
}


var e = function (id)
{
  if (!this.d)
    this.d = {};
  if (!this.d[id])
    this.d[id] = document.getElementById(id);
  return this.d[id];
}

upload.addEventListener("click", function startUpload ()
{
  console.log("clicked upload");
  // Upliad UI
  // stash.className = "stash2";
  progress.className = "";

  console.log("upload " + _files.length + " files");

  var f = _files[0];
  f = _file
  // uploadFile(f);

  var p = 0;
  var f = function ()
  {
    p++;
    progress.style.width = p + "%";
    if (p < 100)
      setTimeout(f, 50);
  };
  f();
  

}, false);



// function startUpload2(files)
// {
//   console.log(files);

//   // Update UI
//   stash.className = "stash2"; // add animation
//   add.className = "hidden";
//   progress.className = "";
//   progress.style.width = 0;

//   for (var i = 0; i < files.length; i ++)
//   {
//     var file = files[i];
//     console.log("filename : " + file.name);
//     console.log("size     : " + file.size);
//     console.log("lastDate : " + file.lastModifiedDate);

//     uploadFile(file);
//   }
// }

function uploadFile(file)
{
  var form = new FormData();
  form.append("file", file);

  var xhr = new XMLHttpRequest();
  xhr.onload = function(res) {
    console.log(res.target.response);
    progress.style.width = stash.style.width;
  };
  xhr.upload.addEventListener(" progress", function(e) {
    if (e.lengthComputable) {
      console.log(e.loaded / e.total);
      var percentage = e.loaded / e.total;

      var width = stash.clientWidth;
      progress.style.width = Math.round(width * percentage) + "px";
    }
  });

  var url = window.location.href.indexOf("2718") >= 0 ? "" : "http://localhost:2718";

  xhr.open("post", url+"/api/1/upload", true);
  xhr.send(form);
}


add.addEventListener("dragenter", function dragenter (e)
{
  console.log(e);
  e.stopPropagation();
  e.preventDefault();


  this.className = "green";
  console.log("dragenter");
}, false);
add.addEventListener("dragover", function dragenter (e)
{
  console.log(e);
  e.stopPropagation();
  e.preventDefault();

  this.className = "green";
  console.log("dragover");

}, false);
add.addEventListener("drop", function dragenter (e)
{
  e.stopPropagation();
  e.preventDefault();

  var dt = e.dataTransfer;
  var files = dt.files;
  addFiles(files);

}, false);
add.addEventListener("click", function dragenter (e)
{
  document.getElementById("file-input").click();
  console.log("clicked");
}, false);


</script>
</body>
</html>