
<html>

<head>

  <link rel="stylesheet" href="style.css">

</head>
<body>

  <div id="stash" class="stsh">

    <div id="preview" class="preview empty">
    </div>

    <div id="info" class="info">
      <div id="text">Drag file here</div>
      <div id="progress" class="progress"></div>
    </div>

    <input id="file-input" class="hidden" type="file" accept="*/*" onchange="setFile(this.files[0])">
  </div>


<script type="text/javascript">

window.e = function (id) { return document.getElementById(id) };
var stsh = {
    file: null,
    uploading: false,
}

function loadPreview ()
{
  var file = stsh.file;

  console.log(file);
  e("preview").className = "preview";

  if (file.type.indexOf("image") >= 0)
  {
    e("preview").style.background = "url(" + URL.createObjectURL(file) + ") no-repeat center center";
    console.log(URL.createObjectURL(file));
  }

  var reader = new FileReader();
  reader.onload = function(e)
  {
    var img = new Image;
    img.onload = function() {
      var s = document.getElementById("stash");
      var preview = document.getElementById("preview");
      // preview.style["background-size"] = "100%";

      console.log("The width of the image is " + img.width + "px.");
      

      return;

      var MAXWIDTH = 500;
      var MAXHEIGHT = 309;
      var dw = img.width / s.clientWidth;
      var dh = img.height / s.clientHeight;
      var scale = img.height/img.width;

      if (img.width < s.clientWidth && img.height < s.clientHeight) {
        // The loaded image is smaller than space availbable, shirnk
        s.style.width = img.width;
        s.style.height = img.height;
      }
      // Image is larger than space available, scale it
      else if (dw > dh) {
        s.style.width = MAXWIDTH;
        s.style.height = MAXWIDTH * scale;
      }
      else {
        scale = 1/scale;
        s.style.width = MAXHEIGHT * scale;
        s.style.height = MAXHEIGHT;
      }

      preview.style["background-size"] = s.width+"px " +s.height+ "px";

      // s.style.width = img.width+"px";
      // s.style.height = img.height+"px";

    };

    img.src = reader.result; 
  };
  
  //reader.readAsDataURL(file);
}


// Called by clicking on preview img
function upload ()
{
  // Check file exists, then upload it
  if (!stsh.file) {
    console.log("uuuhuh, cannot upload null file...");
    return;
  }

  // Upload
  stsh.speedThrottleCalled = false;
  setTimeout(superFastConnectionCallback, 1000);

  e("info").className = "info uploading";
  var _w = 100;
  
  var form = new FormData();
  form.append("file", stsh.file);
  var xhr = new XMLHttpRequest();
  xhr.onload = function(res) {
    e("progress").style.width = _w+"px";

    uploadCompleted(res.target.response);
  };

  xhr.upload.addEventListener("progress", function(event) {
    if (event.lengthComputable) {
      var percentage = event.loaded / event.total;

      e("progress").style.width = _w * percentage + "px";
    }
  });

  var url = window.location.href.indexOf("2718") >= 0 ? "" : "http://localhost:2718";

  xhr.open("post", url+"/api/1/upload", true);
  xhr.send(form);
}


function superFastConnectionCallback ()
{
  if (!stsh.speedThrottleCalled) {
    stsh.speedThrottleCalled = true;
    uploadCompleted();
  }
}
function uploadCompleted (res)
{
  if (res) {
    res = JSON.parse(res);
    console.log(res);
    stsh.url = res.path;
    stsh.status = res.status;
  }

  if (!stsh.speedThrottleCalled || !stsh.url)
    return;

  e("info").className = "info link";
  var text = document.getElementById("text");
  text.innerHTML = "<a href= '/f/" + stsh.url +"'>" + "stsh.ca/f/"+stsh.url +"</a>";
}


function setFile(f)
{
  stsh.file = f;
  loadPreview();

  e("info").className = "info upload";
  e("text").innerHTML = "Upload";
}

e("preview").addEventListener("dragenter", function dragenter (e)
{
  e.stopPropagation();
  e.preventDefault();

  this.className = "green";
  console.log("dragenter");
}, false);
e("preview").addEventListener("dragover", function dragenter (e)
{
  e.stopPropagation();
  e.preventDefault();

  this.className = "green";
  console.log("dragover");

}, false);
e("preview").addEventListener("drop", function dragenter (e)
{
  e.stopPropagation();
  e.preventDefault();

  var dt = e.dataTransfer;
  var files = dt.files;
  
  setFile(files[0]);

}, false);

e("preview").addEventListener("click", function dragenter (e)
{
  // tick();
  document.getElementById("file-input").click();
  console.log("clicked");
}, false);

e("info").addEventListener("click", function dragenter (e)
{
  if (stsh.url) {
    // Nothing, go to there
  } else if (stsh.file) {
    upload ();
  } else {

  }

}, false);


</script>
</body>
</html>

